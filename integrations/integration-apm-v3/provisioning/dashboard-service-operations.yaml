apiVersion: grizzly.grafana.com/v1alpha1
kind: Dashboard
metadata:
    folder: integration-apm-v3
    name: service-operations-dashboard-v3
spec:
    annotations:
        list:
            - builtIn: 1
              datasource:
                type: grafana
                uid: -- Grafana --
              enable: true
              hide: true
              iconColor: rgba(0, 211, 255, 1)
              name: Annotations & Alerts
              type: dashboard
    description: Service Level Dashboard
    editable: false
    fiscalYearStartMonth: 0
    graphTooltip: 0
    links:
        - asDropdown: false
          icon: external link
          includeVars: false
          keepTime: true
          tags: []
          targetBlank: true
          title: Service Metrics
          tooltip: ""
          type: link
          url: /d/k8s-resources-workload/k8s-compute-resources-workload?var-datasource=duplo-metrics&var-cluster=${cluster}&var-namespace=${namespace}&var-type=$__all&var-workload=${service}&var-lokids=$__all
        - asDropdown: false
          icon: external link
          includeVars: false
          keepTime: true
          tags: []
          targetBlank: true
          title: Service Logs
          tooltip: ""
          type: link
          url: /a/grafana-lokiexplore-app/explore/service/xyz/logs?var-ds=duplo-logging&var-filters=service_name%7C%3D%7C${service}&var-filters=cluster%7C%3D%7C${cluster}&var-filters=namespace%7C%3D%7C${namespace}
        - asDropdown: false
          icon: external link
          includeVars: false
          keepTime: true
          tags: []
          targetBlank: true
          title: Service Graph
          tooltip: ""
          type: link
          url: /explore?schemaVersion=1&panes=%7B%22tte%22:%7B%22datasource%22:%22duplo-tracing%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22datasource%22:%7B%22type%22:%22tempo%22,%22uid%22:%22duplo-tracing%22%7D,%22queryType%22:%22serviceMap%22,%22limit%22:20,%22tableType%22:%22traces%22,%22serviceMapQuery%22:%22%7Bsource%3D%5C%22tempo%5C%22,k8s_cluster_name%3D%5C%22${cluster}%5C%22,k8s_namespace_name%3D%5C%22${namespace}%5C%22,service_name%3D%5C%22${service}%5C%22%7D%22%7D%5D,%22range%22:%7B%22from%22:%22${__from}%22,%22to%22:%22${__to}%22%7D%7D%7D
        - asDropdown: false
          icon: external link
          includeVars: false
          keepTime: true
          tags: []
          targetBlank: false
          title: Back to Main Services
          tooltip: ""
          type: link
          url: /d/service-dashboard-v3/service-dashboard-v3?var-cluster=${cluster}&var-namespace=${namespace}&var-service=${service}&var-rate_interval=$__auto
        - asDropdown: true
          icon: external link
          includeVars: false
          keepTime: true
          tags:
            - apm-v3
            - service
            - tempo-mg
          targetBlank: false
          title: All Services | Dashboards
          tooltip: ""
          type: dashboards
          url: ""
    panels:
        - gridPos:
            h: 3
            w: 24
            x: 0
            "y": 0
          id: 1
          options:
            code:
                language: plaintext
                showLineNumbers: false
                showMiniMap: false
            content: "# \U0001F6A8 Investigate RED Metrics\n\nPlease click on the API operation links to drill down into the Service Span Dashboard and analyze Rate, Errors, and Duration (RED metrics) for potential issues.\nFocus on spans with higher latency, increased error percentages, or unusual request rates."
            mode: markdown
          pluginVersion: 11.5.2
          type: text
        - datasource:
            type: prometheus
            uid: duplo-metrics
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                custom:
                    align: center
                    cellOptions:
                        type: auto
                    filterable: false
                    inspect: false
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: semi-dark-green
                          value: null
            overrides:
                - matcher:
                    id: byName
                    options: Duration, p95
                  properties:
                    - id: unit
                      value: s
                    - id: color
                      value:
                        fixedColor: orange
                        mode: fixed
                - matcher:
                    id: byName
                    options: Errors
                  properties:
                    - id: unit
                      value: percentunit
                    - id: color
                      value:
                        fixedColor: dark-red
                        mode: fixed
                - matcher:
                    id: byName
                    options: Rate
                  properties:
                    - id: unit
                      value: reqps
                    - id: color
                      value:
                        fixedColor: '#15a425'
                        mode: fixed
                - matcher:
                    id: byName
                    options: Operation
                  properties:
                    - id: custom.filterable
                      value: true
                    - id: links
                      value:
                        - targetBlank: false
                          title: ""
                          url: /d/service-span-dashboard-v3/service-span-dashboard-v3??var-cluster=${cluster}&var-namespace=${namespace}&var-service=${service}&var-span=${__data.fields.Operation}&var-rate_interval=$__auto
          gridPos:
            h: 23
            w: 24
            x: 0
            "y": 3
          id: 2
          options:
            cellHeight: sm
            footer:
                countRows: false
                enablePagination: true
                fields: ""
                reducer:
                    - sum
                show: false
            frameIndex: 2
            showHeader: true
            sortBy:
                - desc: true
                  displayName: Errors
          pluginVersion: 11.5.2
          targets:
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: false
              expr: appo11y:duration:p95{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name!="__aggregated__"}
              hide: false
              instant: false
              interval: ""
              legendFormat: ""
              range: true
              refId: serviceOverviewOperationsDuration
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: false
              expr: appo11y:error:ratio{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name!="__aggregated__"}
              hide: false
              instant: false
              interval: ""
              legendFormat: ""
              range: true
              refId: serviceOverviewOperationsErrors
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: false
              expr: appo11y:request:rate5m{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name!="__aggregated__"}
              hide: false
              instant: false
              interval: ""
              legendFormat: ""
              range: true
              refId: serviceOverviewOperationsRate
          title: Operations
          transformations:
            - id: timeSeriesTable
              options:
                serviceOverviewOperationsDuration:
                    timeField: Time
                serviceOverviewOperationsDuration-Instant:
                    timeField: Time
                serviceOverviewOperationsErrors:
                    stat: lastNotNull
                    timeField: Time
                serviceOverviewOperationsErrors-Instant:
                    stat: lastNotNull
                    timeField: Time
                serviceOverviewOperationsRate:
                    timeField: Time
                serviceOverviewOperationsRate-Instant:
                    timeField: Time
            - id: joinByField
              options:
                byField: span_name
                mode: outer
            - id: organize
              options:
                excludeByName: 
                    'Trend #serviceOverviewOperationsDuration': false
                    'Trend #serviceOverviewOperationsErrors': false
                    'Trend #serviceOverviewOperationsRate': false
                    __name__ 1: true
                    __name__ 2: true
                    __name__ 3: true
                    k8s_cluster_name 1: true
                    k8s_cluster_name 2: true
                    k8s_cluster_name 3: true
                    k8s_namespace_name 1: true
                    k8s_namespace_name 2: true
                    k8s_namespace_name 3: true
                    service 1: true
                    service 2: true
                    service 3: true
                includeByName: {}
                indexByName: {}
                renameByName:
                    'Trend #serviceOverviewOperationsDuration': Duration, p95
                    'Trend #serviceOverviewOperationsErrors': Errors
                    'Trend #serviceOverviewOperationsRate': Rate
                    span_name: Operation
          type: table
    refresh: ""
    schemaVersion: 40
    tags:
        - apm-v3
        - service
        - tempo-mg
        - operations
    templating:
        list:
            - allowCustomValue: false
              current: {}
              datasource:
                type: prometheus
                uid: duplo-metrics
              definition: label_values(traces_spanmetrics_calls_total{source="tempo"},k8s_cluster_name)
              label: Cluster
              name: cluster
              options: []
              query:
                qryType: 1
                query: label_values(traces_spanmetrics_calls_total{source="tempo"},k8s_cluster_name)
                refId: PrometheusVariableQueryEditor-VariableQuery
              refresh: 1
              regex: ""
              type: query
            - allowCustomValue: false
              current: {}
              datasource:
                type: prometheus
                uid: duplo-metrics
              definition: label_values(traces_spanmetrics_calls_total{source="tempo", k8s_cluster_name="$cluster"},k8s_namespace_name)
              label: Namespace
              name: namespace
              options: []
              query:
                qryType: 1
                query: label_values(traces_spanmetrics_calls_total{source="tempo", k8s_cluster_name="$cluster"},k8s_namespace_name)
                refId: PrometheusVariableQueryEditor-VariableQuery
              refresh: 1
              regex: ""
              type: query
            - allowCustomValue: false
              current: {}
              datasource:
                type: prometheus
                uid: duplo-metrics
              definition: label_values(traces_spanmetrics_calls_total{source="tempo", k8s_cluster_name="$cluster", k8s_namespace_name="$namespace"},service)
              description: ""
              label: Service
              name: service
              options: []
              query:
                qryType: 1
                query: label_values(traces_spanmetrics_calls_total{source="tempo", k8s_cluster_name="$cluster", k8s_namespace_name="$namespace"},service)
                refId: PrometheusVariableQueryEditor-VariableQuery
              refresh: 1
              regex: ""
              type: query
            - auto: true
              auto_count: 30
              auto_min: 1m
              current:
                text: $__auto
                value: $__auto
              label: Interval
              name: rate_interval
              options:
                - selected: false
                  text: 1m
                  value: 1m
                - selected: false
                  text: 10m
                  value: 10m
                - selected: false
                  text: 30m
                  value: 30m
                - selected: false
                  text: 1h
                  value: 1h
                - selected: false
                  text: 6h
                  value: 6h
                - selected: false
                  text: 12h
                  value: 12h
                - selected: false
                  text: 1d
                  value: 1d
                - selected: false
                  text: 7d
                  value: 7d
                - selected: false
                  text: 14d
                  value: 14d
                - selected: false
                  text: 30d
                  value: 30d
              query: 1m,10m,30m,1h,6h,12h,1d,7d,14d,30d
              refresh: 2
              type: interval
    time:
        from: now-1h
        to: now
    timepicker: {}
    timezone: ""
    title: Service Operations Dashboard
    uid: service-operations-dashboard-v3