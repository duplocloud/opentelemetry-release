apiVersion: grizzly.grafana.com/v1alpha1
kind: Dashboard
metadata:
    folder: integration-apm-v3
    name: service-dashboard-v3
spec:
    annotations:
        list:
            - builtIn: 1
              datasource:
                type: grafana
                uid: -- Grafana --
              enable: true
              hide: true
              iconColor: rgba(0, 211, 255, 1)
              name: Annotations & Alerts
              type: dashboard
    description: Service Level Dashboard
    editable: false
    fiscalYearStartMonth: 0
    graphTooltip: 0
    links:
        - asDropdown: false
          icon: external link
          includeVars: false
          keepTime: true
          tags: []
          targetBlank: true
          title: Service Infra Metrics
          tooltip: ""
          type: link
          url: /d/k8s-resources-workload/k8s-compute-resources-workload?var-datasource=duplo-metrics&var-cluster=${cluster}&var-namespace=${namespace}&var-type=$__all&var-workload=${service}&var-lokids=$__all
        - asDropdown: false
          icon: external link
          includeVars: false
          keepTime: true
          tags: []
          targetBlank: true
          title: Service Logs
          tooltip: ""
          type: link
          url: /a/grafana-lokiexplore-app/explore/service/xyz/logs?var-ds=duplo-logging&var-filters=service_name%7C%3D%7C${service}&var-filters=cluster%7C%3D%7C${cluster}&var-filters=namespace%7C%3D%7C${namespace}
        - asDropdown: false
          icon: external link
          includeVars: false
          keepTime: true
          tags: []
          targetBlank: true
          title: Service Graph
          tooltip: ""
          type: link
          url: /explore?schemaVersion=1&panes=%7B%22tte%22:%7B%22datasource%22:%22duplo-tracing%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22datasource%22:%7B%22type%22:%22tempo%22,%22uid%22:%22duplo-tracing%22%7D,%22queryType%22:%22serviceMap%22,%22limit%22:20,%22tableType%22:%22traces%22,%22serviceMapQuery%22:%22%7Bsource%3D%5C%22tempo%5C%22,k8s_cluster_name%3D%5C%22${cluster}%5C%22,k8s_namespace_name%3D%5C%22${namespace}%5C%22,service_name%3D%5C%22${service}%5C%22%7D%22%7D%5D,%22range%22:%7B%22from%22:%22${__from}%22,%22to%22:%22${__to}%22%7D%7D%7D
        - asDropdown: false
          icon: external link
          includeVars: false
          keepTime: true
          tags: []
          targetBlank: false
          title: Back to Services Overview
          tooltip: ""
          type: link
          url: /d/service-overview-dashboard-v3/service-overview-dashboard-v3?var-rate_interval=$__auto
        - asDropdown: false
          icon: external link
          includeVars: false
          keepTime: true
          tags: []
          targetBlank: false
          title: Service Operations
          tooltip: ""
          type: link
          url: /d/service-operations-dashboard-v3/service-operations-dashboard-v3?var-cluster=${cluster}&var-namespace=${namespace}&var-service=${service}&var-rate_interval=$__auto
        - asDropdown: true
          icon: external link
          includeVars: false
          keepTime: true
          tags:
            - apm-v3
            - service
            - tempo-mg
          targetBlank: false
          title: All Services | Dashboards
          tooltip: ""
          type: dashboards
          url: ""
    panels:
        - fieldConfig:
            defaults: {}
            overrides: []
          gridPos:
            h: 3
            w: 12
            x: 0
            "y": 0
          id: 9
          options:
            code:
                language: plaintext
                showLineNumbers: false
                showMiniMap: false
            content: "# \U0001F6A8 Investigate RED Metrics\n\nPlease drill down to a 3-hour time window.\nThen, open the \U0001F517 Rate, Errors & Duration metrics panel links to investigate further."
            mode: markdown
          pluginVersion: 11.5.2
          title: ""
          type: text
        - datasource:
            type: prometheus
            uid: duplo-metrics
          description: "**Apdex Score** measures user satisfaction based on response time thresholds:\n\n\U0001F7E2 **Green (0.94+)**: Excellent performance - Most users are satisfied\n\U0001F7E1 **Yellow (0.75-0.94)**: Acceptable performance - Some users may experience delays\n\U0001F534 **Red (<0.75)**: Poor performance - Many users are experiencing issues\n\n**Calculation**: (Satisfied + Tolerated/2) / Total Requests\n- **Satisfied**: Requests ≤ 1 second\n- **Tolerated**: Requests between 1-4 seconds (counted as half)\n- **Total**: All requests"
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                    seriesBy: last
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: dark-red
                          value: null
                        - color: light-yellow
                          value: 0.75
                        - color: dark-green
                          value: 0.94
            overrides: []
          gridPos:
            h: 3
            w: 12
            x: 12
            "y": 0
          id: 11
          options:
            colorMode: value
            graphMode: area
            justifyMode: auto
            orientation: auto
            percentChangeColorMode: standard
            reduceOptions:
                calcs:
                    - lastNotNull
                fields: ""
                values: false
            showPercentChange: false
            textMode: auto
            wideLayout: true
          pluginVersion: 11.5.2
          targets:
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: false
              expr: |-
                (
                  # 1. SATISFIED COMPONENT (Cumulative)
                  # We use sum by() here primarily to DROP the 'le' label so we can add the result
                  # to the Tolerating component later without label mismatch errors.
                  sum by (k8s_cluster_name, k8s_namespace_name, service, span_name) (
                    (
                      # Custom Threshold
                      appo11y:duration:distribution{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}
                      * on(k8s_cluster_name, k8s_namespace_name, service, span_name, le) group_left()
                      service_apdex_threshold_satisfied_bucket
                    )
                    or
                    (
                      # Fallback Default (0.512)
                      appo11y:duration:distribution{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__", le="0.512"}
                      unless on(k8s_cluster_name, k8s_namespace_name, service, span_name)
                      service_apdex_threshold_satisfied_bucket
                    )
                  )
                  +
                  # 2. TOLERATING COMPONENT (Cumulative)
                  sum by (k8s_cluster_name, k8s_namespace_name, service, span_name) (
                    (
                      # Custom Threshold
                      appo11y:duration:distribution{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}
                      * on(k8s_cluster_name, k8s_namespace_name, service, span_name, le) group_left()
                      service_apdex_threshold_tolerating_bucket
                    )
                    or
                    (
                      # Fallback Default (2.05)
                      appo11y:duration:distribution{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__", le="2.05"}
                      unless on(k8s_cluster_name, k8s_namespace_name, service, span_name)
                      service_apdex_threshold_tolerating_bucket
                    )
                  )
                )
                / 2
                /
                # 3. TOTAL SAMPLES
                sum by (k8s_cluster_name, k8s_namespace_name, service, span_name) (
                  appo11y:duration:distribution{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__", le="+Inf"}
                )
              hide: false
              instant: true
              interval: ""
              legendFormat: Apdex Score
              range: false
              refId: apdexQuery
          title: Apdex Score (T = ${appdex_threshold}s)
          type: stat
        - datasource:
            type: prometheus
            uid: duplo-metrics
          fieldConfig:
            defaults:
                color:
                    mode: palette-classic
                custom:
                    axisBorderShow: false
                    axisCenteredZero: false
                    axisColorMode: text
                    axisLabel: ""
                    axisPlacement: auto
                    barAlignment: 0
                    barWidthFactor: 0.6
                    drawStyle: line
                    fillOpacity: 0
                    gradientMode: none
                    hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                    insertNulls: false
                    lineInterpolation: linear
                    lineWidth: 1
                    pointSize: 5
                    scaleDistribution:
                        type: linear
                    showPoints: auto
                    spanNulls: false
                    stacking:
                        group: A
                        mode: none
                    thresholdsStyle:
                        mode: "off"
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: semi-dark-green
                          value: null
                unit: reqps
            overrides:
                - matcher:
                    id: byName
                    options: Rate
                  properties:
                    - id: color
                      value:
                        fixedColor: '#1bc2c9'
                        mode: fixed
          gridPos:
            h: 9
            w: 8
            x: 0
            "y": 3
          id: 2
          links:
            - targetBlank: true
              title: Drill Down To Traces
              url: /a/grafana-exploretraces-app/explore?var-filters=resource.k8s.cluster.name%7C%3D%7C${cluster}&var-filters=resource.k8s.namespace.name%7C%3D%7C${namespace}&var-filters=resource.service.name%7C%3D%7C${service}&var-metric=rate&from=${__from}&to=${__to}&timezone=browser&var-ds=duplo-tracing
          options:
            legend:
                calcs: []
                displayMode: list
                placement: bottom
                showLegend: true
            tooltip:
                hideZeros: false
                mode: single
                sort: none
          pluginVersion: 11.5.2
          targets:
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: true
              expr: appo11y:request:rate5m{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}
              hide: false
              instant: true
              interval: ""
              legendFormat: Rate
              range: true
              refId: serviceRateQuery
          title: Rate
          transformations:
            - id: merge
              options: {}
          type: timeseries
        - datasource:
            type: prometheus
            uid: duplo-metrics
          fieldConfig:
            defaults:
                color:
                    mode: palette-classic
                custom:
                    axisBorderShow: false
                    axisCenteredZero: false
                    axisColorMode: text
                    axisLabel: ""
                    axisPlacement: auto
                    barAlignment: 0
                    barWidthFactor: 0.6
                    drawStyle: line
                    fillOpacity: 0
                    gradientMode: none
                    hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                    insertNulls: false
                    lineInterpolation: linear
                    lineWidth: 1
                    pointSize: 5
                    scaleDistribution:
                        type: linear
                    showPoints: auto
                    spanNulls: false
                    stacking:
                        group: A
                        mode: none
                    thresholdsStyle:
                        mode: "off"
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: semi-dark-green
                          value: null
                unit: percentunit
            overrides:
                - matcher:
                    id: byName
                    options: Errors
                  properties:
                    - id: color
                      value:
                        fixedColor: dark-red
                        mode: fixed
          gridPos:
            h: 9
            w: 8
            x: 8
            "y": 3
          id: 3
          links:
            - targetBlank: true
              title: Drill Down To Traces
              url: /a/grafana-exploretraces-app/explore?var-filters=resource.k8s.cluster.name%7C%3D%7C${cluster}&var-filters=resource.k8s.namespace.name%7C%3D%7C${namespace}&var-filters=resource.service.name%7C%3D%7C${service}&var-metric=errors&from=${__from}&to=${__to}&timezone=browser&var-ds=duplo-tracing
          options:
            legend:
                calcs: []
                displayMode: list
                placement: bottom
                showLegend: true
            tooltip:
                hideZeros: false
                mode: single
                sort: none
          pluginVersion: 11.5.2
          targets:
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: true
              expr: appo11y:error:ratio{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}
              hide: false
              instant: false
              interval: ""
              legendFormat: Errors
              range: true
              refId: serviceErrorsQuery
          title: Errors
          transformations:
            - id: joinByField
              options:
                byField: Time
                mode: outer
            - id: merge
              options: {}
          type: timeseries
        - datasource:
            type: prometheus
            uid: duplo-metrics
          fieldConfig:
            defaults:
                color:
                    mode: palette-classic
                custom:
                    axisBorderShow: false
                    axisCenteredZero: false
                    axisColorMode: text
                    axisLabel: ""
                    axisPlacement: auto
                    barAlignment: 0
                    barWidthFactor: 0.6
                    drawStyle: line
                    fillOpacity: 0
                    gradientMode: none
                    hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                    insertNulls: false
                    lineInterpolation: linear
                    lineWidth: 1
                    pointSize: 5
                    scaleDistribution:
                        type: linear
                    showPoints: auto
                    spanNulls: false
                    stacking:
                        group: A
                        mode: none
                    thresholdsStyle:
                        mode: "off"
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: semi-dark-green
                          value: null
                unit: s
            overrides:
                - matcher:
                    id: byName
                    options: P99
                  properties:
                    - id: color
                      value:
                        fixedColor: dark-green
                        mode: fixed
                    - id: custom.cellOptions
                      value:
                        type: sparkline
                - matcher:
                    id: byName
                    options: P95
                  properties:
                    - id: color
                      value:
                        fixedColor: semi-dark-yellow
                        mode: fixed
                    - id: custom.cellOptions
                      value:
                        type: sparkline
                - matcher:
                    id: byName
                    options: AVG
                  properties:
                    - id: color
                      value:
                        fixedColor: blue
                        mode: fixed
                    - id: custom.cellOptions
                      value:
                        type: sparkline
          gridPos:
            h: 9
            w: 8
            x: 16
            "y": 3
          id: 4
          links:
            - targetBlank: true
              title: Drill Down To Traces
              url: /a/grafana-exploretraces-app/explore?var-filters=resource.k8s.cluster.name%7C%3D%7C${cluster}&var-filters=resource.k8s.namespace.name%7C%3D%7C${namespace}&var-filters=resource.service.name%7C%3D%7C${service}&var-metric=duration&from=${__from}&to=${__to}&timezone=browser&var-ds=duplo-tracing
          options:
            legend:
                calcs: []
                displayMode: list
                placement: bottom
                showLegend: true
            tooltip:
                hideZeros: false
                mode: single
                sort: none
          pluginVersion: 11.5.2
          targets:
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: true
              expr: appo11y:duration:p99{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}
              hide: false
              instant: false
              interval: ""
              legendFormat: P99
              range: true
              refId: serviceP99Query
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: true
              expr: appo11y:duration:p95{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}
              hide: false
              instant: false
              interval: ""
              legendFormat: P95
              range: true
              refId: serviceP95Query
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: true
              expr: appo11y:duration:avg{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}
              hide: false
              instant: false
              interval: ""
              legendFormat: AVG
              range: true
              refId: serviceAvgQuery
          title: Duration
          transformations:
            - id: joinByField
              options:
                byField: Time
                mode: outer
            - id: merge
              options: {}
          type: timeseries
        - datasource:
            type: prometheus
            uid: duplo-metrics
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: orange
                          value: null
                unit: short
            overrides: []
          gridPos:
            h: 11
            w: 24
            x: 0
            "y": 12
          id: 5
          options:
            displayMode: gradient
            legend:
                calcs: []
                displayMode: list
                placement: bottom
                showLegend: false
            maxVizHeight: 300
            minVizHeight: 16
            minVizWidth: 8
            namePlacement: auto
            orientation: vertical
            reduceOptions:
                calcs: [
                  "sum"
                ]
                fields: ""
                values: false
            showUnfilled: false
            sizing: auto
            valueMode: text
          pluginVersion: 11.5.2
          targets:
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: false
              expr: appo11y:duration:distribution{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}
              format: heatmap
              hide: false
              instant: false
              interval: ""
              legendFormat: '{{le}}'
              range: true
              refId: serviceRateQuery
          title: Duration distribution
          transformations:
            - id: renameByRegex
              options:
                regex: (^\d+\.\d+$)
                renamePattern: $1 s
          type: bargauge
        - datasource:
            type: prometheus
            uid: duplo-metrics
          description: "**Apdex Score** measures user satisfaction based on response time thresholds:\n\n\U0001F7E2 **Green (0.94+)**: Excellent performance - Most users are satisfied\n\U0001F7E1 **Yellow (0.75-0.94)**: Acceptable performance - Some users may experience delays\n\U0001F534 **Red (<0.75)**: Poor performance - Many users are experiencing issues\n\n**Calculation**: (Satisfied + Tolerated/2) / Total Requests\n- **Satisfied**: Requests ≤ 1 second\n- **Tolerated**: Requests between 1-4 seconds (counted as half)\n- **Total**: All requests"
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                    seriesBy: last
                custom:
                    axisBorderShow: false
                    axisCenteredZero: false
                    axisColorMode: text
                    axisGridShow: true
                    axisLabel: ""
                    axisPlacement: auto
                    axisSoftMax: 1
                    axisSoftMin: 0
                    barAlignment: 0
                    barWidthFactor: 0.6
                    drawStyle: line
                    fillOpacity: 0
                    gradientMode: scheme
                    hideFrom:
                        legend: false
                        tooltip: false
                        viz: false
                    insertNulls: false
                    lineInterpolation: linear
                    lineWidth: 1
                    pointSize: 5
                    scaleDistribution:
                        type: linear
                    showPoints: auto
                    spanNulls: false
                    stacking:
                        group: A
                        mode: none
                    thresholdsStyle:
                        mode: "off"
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: dark-red
                          value: null
                        - color: light-yellow
                          value: 0.75
                        - color: dark-green
                          value: 0.94
            overrides: []
          gridPos:
            h: 10
            w: 12
            x: 12
            "y": 12
          id: 10
          options:
            legend:
                calcs:
                    - mean
                    - max
                    - min
                displayMode: list
                placement: bottom
                showLegend: true
            tooltip:
                hideZeros: false
                mode: single
                sort: none
          pluginVersion: 11.5.2
          targets:
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: true
              expr: |-
                (
                  # 1. SATISFIED COMPONENT (Cumulative)
                  # We use sum by() here primarily to DROP the 'le' label so we can add the result
                  # to the Tolerating component later without label mismatch errors.
                  sum by (k8s_cluster_name, k8s_namespace_name, service, span_name) (
                    (
                      # Custom Threshold
                      appo11y:duration:distribution{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}
                      * on(k8s_cluster_name, k8s_namespace_name, service, span_name, le) group_left()
                      service_apdex_threshold_satisfied_bucket
                    )
                    or
                    (
                      # Fallback Default (0.512)
                      appo11y:duration:distribution{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__", le="0.512"}
                      unless on(k8s_cluster_name, k8s_namespace_name, service, span_name)
                      service_apdex_threshold_satisfied_bucket
                    )
                  )
                  +
                  # 2. TOLERATING COMPONENT (Cumulative)
                  sum by (k8s_cluster_name, k8s_namespace_name, service, span_name) (
                    (
                      # Custom Threshold
                      appo11y:duration:distribution{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}
                      * on(k8s_cluster_name, k8s_namespace_name, service, span_name, le) group_left()
                      service_apdex_threshold_tolerating_bucket
                    )
                    or
                    (
                      # Fallback Default (2.05)
                      appo11y:duration:distribution{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__", le="2.05"}
                      unless on(k8s_cluster_name, k8s_namespace_name, service, span_name)
                      service_apdex_threshold_tolerating_bucket
                    )
                  )
                )
                / 2
                /
                # 3. TOTAL SAMPLES
                sum by (k8s_cluster_name, k8s_namespace_name, service, span_name) (
                  appo11y:duration:distribution{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__", le="+Inf"}
                )
              hide: false
              instant: false
              interval: ""
              legendFormat: Apdex Score
              range: true
              refId: apdexQuery
          title: Apdex Score ( T= ${appdex_threshold}s)
          type: timeseries
        - datasource:
            type: prometheus
            uid: duplo-metrics
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                custom:
                    align: center
                    cellOptions:
                        type: auto
                    filterable: false
                    inspect: false
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: semi-dark-green
                          value: null
            overrides:
                - matcher:
                    id: byName
                    options: Duration, p95
                  properties:
                    - id: unit
                      value: s
                    - id: color
                      value:
                        fixedColor: orange
                        mode: fixed
                - matcher:
                    id: byName
                    options: Errors
                  properties:
                    - id: unit
                      value: percentunit
                    - id: color
                      value:
                        fixedColor: dark-red
                        mode: fixed
                - matcher:
                    id: byName
                    options: Rate
                  properties:
                    - id: unit
                      value: reqps
                    - id: color
                      value:
                        fixedColor: '#15a425'
                        mode: fixed
                - matcher:
                    id: byName
                    options: Name
                  properties:
                    - id: links
                      value:
                        - targetBlank: false
                          title: ""
                          url: /d/service-dashboard-v3/service-dashboard-v3?var-cluster=${cluster}&var-namespace=${namespace}&var-service=${__data.fields.Name}&var-rate_interval=$__auto
                    - id: custom.filterable
                      value: true
          gridPos:
            h: 10
            w: 12
            x: 0
            "y": 23
          id: 6
          options:
            cellHeight: sm
            footer:
                countRows: false
                enablePagination: true
                fields: ""
                reducer:
                    - sum
                show: false
            frameIndex: 2
            showHeader: true
            sortBy: []
          pluginVersion: 11.5.2
          targets:
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: false
              expr: histogram_quantile(0.95, sum(rate(traces_service_graph_request_server_seconds_bucket{source="tempo", k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", server=~"$service", client!="user"} [$rate_interval])) by (le, client, k8s_cluster_name, k8s_namespace_name))
              hide: false
              instant: false
              interval: ""
              legendFormat: ""
              range: true
              refId: serviceOverviewInboundDuration
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: false
              expr: (sum(rate(traces_service_graph_request_failed_total{source="tempo", k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", server=~"$service", client!="user"} [$rate_interval])) by (client, k8s_cluster_name, k8s_namespace_name) OR sum(rate(traces_service_graph_request_total{source="tempo", k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", server=~"$service", client!="user"} [$rate_interval])) by (client, k8s_cluster_name, k8s_namespace_name) * 0) / sum(rate(traces_service_graph_request_total{source="tempo", k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", server=~"$service",  client!="user"} [$rate_interval])) by (client, k8s_cluster_name, k8s_namespace_name)
              hide: false
              instant: false
              interval: ""
              legendFormat: ""
              range: true
              refId: serviceOverviewInboundErrors
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: false
              expr: sum(rate(traces_service_graph_request_total{source="tempo", k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", server=~"$service", client!="user"} [$rate_interval])) by (client, k8s_cluster_name, k8s_namespace_name)
              hide: false
              instant: false
              interval: ""
              legendFormat: ""
              range: true
              refId: serviceOverviewInboundRate
          title: Inbound
          transformations:
            - id: timeSeriesTable
              options:
                serviceOverviewInboundDuration:
                    timeField: Time
                serviceOverviewInboundErrors:
                    timeField: Time
                serviceOverviewInboundRate:
                    timeField: Time
            - id: joinByField
              options:
                byField: client
                mode: outer
            - id: organize
              options:
                excludeByName:
                    k8s_cluster_name 1: true
                    k8s_cluster_name 2: true
                    k8s_cluster_name 3: true
                    k8s_namespace_name 1: true
                    k8s_namespace_name 2: true
                    k8s_namespace_name 3: true
                includeByName: {}
                indexByName: {}
                renameByName:
                    'Trend #serviceOverviewInboundDuration': Duration, p95
                    'Trend #serviceOverviewInboundErrors': Errors
                    'Trend #serviceOverviewInboundRate': Rate
                    client: Name
          type: table
        - datasource:
            type: prometheus
            uid: duplo-metrics
          fieldConfig:
            defaults:
                color:
                    mode: thresholds
                custom:
                    align: center
                    cellOptions:
                        type: auto
                    filterable: false
                    inspect: false
                mappings: []
                thresholds:
                    mode: absolute
                    steps:
                        - color: semi-dark-green
                          value: null
            overrides:
                - matcher:
                    id: byName
                    options: Duration, p95
                  properties:
                    - id: unit
                      value: s
                    - id: color
                      value:
                        fixedColor: orange
                        mode: fixed
                - matcher:
                    id: byName
                    options: Errors
                  properties:
                    - id: unit
                      value: percentunit
                    - id: color
                      value:
                        fixedColor: dark-red
                        mode: fixed
                - matcher:
                    id: byName
                    options: Rate
                  properties:
                    - id: unit
                      value: reqps
                    - id: color
                      value:
                        fixedColor: '#15a425'
                        mode: fixed
                - matcher:
                    id: byName
                    options: Name
                  properties:
                    - id: custom.filterable
                      value: true
                    - id: links
                      value:
                        - title: ""
                          url: /d/service-dashboard-v3/service-dashboard-v3?var-cluster=${cluster}&var-namespace=${namespace}&var-service=${__data.fields.Name}&var-rate_interval=$__auto
          gridPos:
            h: 10
            w: 12
            x: 12
            "y": 22
          id: 7
          options:
            cellHeight: sm
            footer:
                countRows: false
                enablePagination: true
                fields: ""
                reducer:
                    - sum
                show: false
            frameIndex: 2
            showHeader: true
            sortBy:
                - desc: true
                  displayName: Errors
          pluginVersion: 11.5.2
          targets:
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: false
              expr: histogram_quantile(0.95, sum(rate(traces_service_graph_request_server_seconds_bucket{source="tempo", k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", client=~"$service"} [$rate_interval])) by (le, server, k8s_cluster_name, k8s_namespace_name))
              hide: false
              instant: false
              interval: ""
              legendFormat: ""
              range: true
              refId: serviceOverviewOutboundDatabasesDuration
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: false
              expr: (sum(rate(traces_service_graph_request_failed_total{source="tempo", k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", client=~"$service"} [$rate_interval])) by (server, k8s_cluster_name, k8s_namespace_name) OR sum(rate(traces_service_graph_request_total{source="tempo", k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", client=~"$service"} [$rate_interval])) by (server, k8s_cluster_name, k8s_namespace_name) * 0) / sum(rate(traces_service_graph_request_total{source="tempo", k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", client=~"$service"} [$rate_interval])) by (server, k8s_cluster_name, k8s_namespace_name)
              hide: false
              instant: false
              interval: ""
              legendFormat: ""
              range: true
              refId: serviceOverviewOutboundDatabasesErrors
            - datasource:
                type: prometheus
                uid: duplo-metrics
              editorMode: code
              exemplar: false
              expr: sum(rate(traces_service_graph_request_total{source="tempo", k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", client=~"$service"} [$rate_interval])) by (server, k8s_cluster_name, k8s_namespace_name)
              hide: false
              instant: false
              interval: ""
              legendFormat: ""
              range: true
              refId: serviceOverviewOutboundDatabasesRate
          title: Outbound & databases
          transformations:
            - id: timeSeriesTable
              options:
                serviceOverviewInboundDuration:
                    timeField: Time
                serviceOverviewInboundErrors:
                    timeField: Time
                serviceOverviewInboundRate:
                    timeField: Time
                serviceOverviewOutboundDatabasesDuration:
                    timeField: Time
                serviceOverviewOutboundDatabasesErrors:
                    timeField: Time
                serviceOverviewOutboundDatabasesRate:
                    timeField: Time
            - id: joinByField
              options:
                byField: server
                mode: outer
            - id: organize
              options:
                excludeByName:
                    k8s_cluster_name 1: true
                    k8s_cluster_name 2: true
                    k8s_cluster_name 3: true
                    k8s_namespace_name 1: true
                    k8s_namespace_name 2: true
                    k8s_namespace_name 3: true
                includeByName: {}
                indexByName: {}
                renameByName:
                    'Trend #serviceOverviewInboundDuration': Duration, p95
                    'Trend #serviceOverviewInboundErrors': Errors
                    'Trend #serviceOverviewInboundRate': Rate
                    'Trend #serviceOverviewOutboundDatabasesDuration': Duration, p95
                    'Trend #serviceOverviewOutboundDatabasesErrors': Errors
                    'Trend #serviceOverviewOutboundDatabasesRate': Rate
                    client: Name
                    server: Name
          type: table
    preload: false
    refresh: ""
    schemaVersion: 40
    tags:
        - apm-v3
        - service
        - tempo-mg
        - main
    templating:
        list:
            - allowCustomValue: false
              current: {}
              datasource:
                type: prometheus
                uid: duplo-metrics
              definition: label_values(traces_spanmetrics_calls_total{source="tempo"},k8s_cluster_name)
              label: Cluster
              name: cluster
              options: []
              query:
                qryType: 1
                query: label_values(traces_spanmetrics_calls_total{source="tempo"},k8s_cluster_name)
                refId: PrometheusVariableQueryEditor-VariableQuery
              refresh: 1
              regex: ""
              type: query
            - allowCustomValue: false
              current: {}
              datasource:
                type: prometheus
                uid: duplo-metrics
              definition: label_values(traces_spanmetrics_calls_total{source="tempo", k8s_cluster_name="$cluster"},k8s_namespace_name)
              label: Namespace
              name: namespace
              options: []
              query:
                qryType: 1
                query: label_values(traces_spanmetrics_calls_total{source="tempo", k8s_cluster_name="$cluster"},k8s_namespace_name)
                refId: PrometheusVariableQueryEditor-VariableQuery
              refresh: 1
              regex: ""
              type: query
            - allowCustomValue: false
              current: {}
              datasource:
                type: prometheus
                uid: duplo-metrics
              definition: label_values(traces_spanmetrics_calls_total{source="tempo", k8s_cluster_name="$cluster", k8s_namespace_name="$namespace", span_kind!="SPAN_KIND_CLIENT"},service)
              description: ""
              label: Service
              name: service
              options: []
              query:
                qryType: 1
                query: label_values(traces_spanmetrics_calls_total{source="tempo", k8s_cluster_name="$cluster", k8s_namespace_name="$namespace", span_kind!="SPAN_KIND_CLIENT"},service)
                refId: PrometheusVariableQueryEditor-VariableQuery
              refresh: 1
              regex: ""
              type: query
            - auto: true
              auto_count: 30
              auto_min: 1m
              current:
                text: $__auto
                value: $__auto
              label: Interval
              name: rate_interval
              options:
                - selected: false
                  text: 1m
                  value: 1m
                - selected: false
                  text: 10m
                  value: 10m
                - selected: false
                  text: 30m
                  value: 30m
                - selected: false
                  text: 1h
                  value: 1h
                - selected: false
                  text: 6h
                  value: 6h
                - selected: false
                  text: 12h
                  value: 12h
                - selected: false
                  text: 1d
                  value: 1d
                - selected: false
                  text: 7d
                  value: 7d
                - selected: false
                  text: 14d
                  value: 14d
                - selected: false
                  text: 30d
                  value: 30d
              query: 1m,10m,30m,1h,6h,12h,1d,7d,14d,30d
              refresh: 2
              type: interval
            - current:
                text: "0.512"
                value: "0.512"
              datasource:
                type: prometheus
                uid: duplo-metrics
              definition: query_result(service_apdex_threshold_satisfied_bucket{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}    OR    label_replace(    absent(service_apdex_threshold_satisfied_bucket{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}),    "le", "0.512", "service", ".*"  ))
              hide: 2
              label: appdex_threshold
              name: appdex_threshold
              options: []
              query:
                qryType: 3
                query: query_result(service_apdex_threshold_satisfied_bucket{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}    OR    label_replace(    absent(service_apdex_threshold_satisfied_bucket{k8s_cluster_name=~"$cluster", k8s_namespace_name=~"$namespace", service=~"$service", span_name="__aggregated__"}),    "le", "0.512", "service", ".*"  ))
                refId: PrometheusVariableQueryEditor-VariableQuery
              refresh: 1
              regex: /le="([^"]+)"/
              type: query
    time:
        from: now-1h
        to: now
    timepicker: {}
    timezone: ""
    title: Service Dashboard
    uid: service-dashboard-v3
    weekStart: ""
