namespace: app-o11y
groups:
    - name: baseline-duration
      interval: 1m
      rules:
        - record: appo11y:duration:p95:prediction
          expr: quantile_over_time(0.5, appo11y:duration:p95[1h]) unless (appo11y:request:rate5m unless appo11y:request:rate5m:select)
        - record: appo11y:duration:p95:stddev
          expr: avg_over_time(appo11y:duration:p95:stddev_1h[1d2h])
        - record: appo11y:duration:p95:anomaly_lower_threshold
          expr: clamp_min(min without (prediction_type) (label_replace(last_over_time(appo11y:duration:p95:prediction[1m]) - last_over_time(appo11y:duration:p95:stddev[1m]) * on () group_left () appo11y:duration:threshold_by_stddev, "prediction_type", "stddev", "", "") or label_replace(last_over_time(appo11y:duration:p95:prediction[1m]) - last_over_time(appo11y:duration:p95:prediction[1m]) * on () group_left () appo11y:duration:threshold_margin, "prediction_type", "margin", "", "")), 0)
        - record: appo11y:duration:p95:anomaly_upper_threshold
          expr: max without (prediction_type) (label_replace(last_over_time(appo11y:duration:p95:prediction[1m]) + last_over_time(appo11y:duration:p95:stddev[1m]) * on () group_left () appo11y:duration:threshold_by_stddev, "prediction_type", "stddev", "", "") or label_replace(last_over_time(appo11y:duration:p95:prediction[1m]) + last_over_time(appo11y:duration:p95:prediction[1m]) * on () group_left () appo11y:duration:threshold_margin, "prediction_type", "margin", "", ""))
    - name: baseline-duration-base
      interval: 1m
      rules:
        - record: appo11y:duration:p95
          expr: histogram_quantile(0.95, sum by (k8s_cluster_name, k8s_namespace_name, service, span_name, le) (rate(traces_spanmetrics_latency_bucket{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m)))
        - record: appo11y:duration:p95
          expr: histogram_quantile(0.95, sum by (k8s_cluster_name, k8s_namespace_name, service, le) (rate(traces_spanmetrics_latency_bucket{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m)))
          labels:
            span_name: __aggregated__
        - record: appo11y:duration:p99
          expr: histogram_quantile(0.99, sum by (k8s_cluster_name, k8s_namespace_name, service, span_name, le) (rate(traces_spanmetrics_latency_bucket{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m)))
        - record: appo11y:duration:p99
          expr: histogram_quantile(0.99, sum by (k8s_cluster_name, k8s_namespace_name, service, le) (rate(traces_spanmetrics_latency_bucket{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m)))
          labels:
            span_name: __aggregated__
        - record: appo11y:duration:avg
          expr: sum(rate(traces_spanmetrics_latency_sum{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m)) by (k8s_cluster_name, k8s_namespace_name, service, span_name) / (sum(rate(traces_spanmetrics_latency_count{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m)) by (k8s_cluster_name, k8s_namespace_name, service, span_name))
        - record: appo11y:duration:avg
          expr: sum(rate(traces_spanmetrics_latency_sum{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m)) by (k8s_cluster_name, k8s_namespace_name, service) / (sum(rate(traces_spanmetrics_latency_count{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m)) by (k8s_cluster_name, k8s_namespace_name, service))
          labels:
            span_name: __aggregated__
        - record: appo11y:duration:distribution
          expr: sum by (k8s_cluster_name, k8s_namespace_name, service, span_name, le) (increase(traces_spanmetrics_latency_bucket{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m))
        - record: appo11y:duration:distribution
          expr: sum by (k8s_cluster_name, k8s_namespace_name, service, le) (increase(traces_spanmetrics_latency_bucket{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m))
          labels:
            span_name: __aggregated__
    - name: baseline-error-ratio
      interval: 1m
      rules:
        - record: appo11y:error:ratio
          expr: (sum by (k8s_cluster_name, k8s_namespace_name, service, span_name) (rate(traces_spanmetrics_latency_count{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER",status_code="STATUS_CODE_ERROR"}[5m] offset 1m)) or sum by (k8s_cluster_name, k8s_namespace_name, service, span_name) (rate(traces_spanmetrics_latency_count{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m)) * 0) / sum by (k8s_cluster_name, k8s_namespace_name, service, span_name) (rate(traces_spanmetrics_latency_count{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m))
        - record: appo11y:error:ratio
          expr: (sum by (k8s_cluster_name, k8s_namespace_name, service,) (rate(traces_spanmetrics_latency_count{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER",status_code="STATUS_CODE_ERROR"}[5m] offset 1m)) or sum by (k8s_cluster_name, k8s_namespace_name, service,) (rate(traces_spanmetrics_latency_count{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m)) * 0) / sum by (k8s_cluster_name, k8s_namespace_name, service,) (rate(traces_spanmetrics_latency_count{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m))
          labels:
            span_name: __aggregated__
        - record: appo11y:error:ratio:prediction
          expr: avg_over_time(appo11y:error:ratio[1h])
        - record: appo11y:error:ratio:stddev
          expr: avg_over_time(appo11y:error:ratio:stddev_1h[1d2h])
        - record: appo11y:error:ratio:anomaly_upper_threshold
          expr: clamp_max(max without (prediction_type) (label_replace(last_over_time(appo11y:error:ratio:prediction[1m]) + last_over_time(appo11y:error:ratio:stddev[1m]) * on () group_left () appo11y:error:ratio:threshold_by_stddev, "prediction_type", "stddev", "", "") or label_replace(last_over_time(appo11y:error:ratio:prediction[1m]) + last_over_time(appo11y:error:ratio:prediction[1m]) * on () group_left () appo11y:error:ratio:threshold_margin, "prediction_type", "margin", "", "")), 1)
    - name: baseline-stddev-1h
      interval: 5m
      rules:
        - record: appo11y:request:rate5m:stddev_st_1h
          expr: stddev_over_time(appo11y:request:rate5m:select[1h]) > appo11y:request:rate5m:prediction_st * on () group_left () appo11y:request:stddev:threshold_by_covar
        - record: appo11y:duration:p95:stddev_1h
          expr: stddev_over_time(appo11y:duration:p95[1h]) unless (appo11y:request:rate5m unless appo11y:request:rate5m:select) > avg_over_time(appo11y:duration:p95[1h]) * on () group_left () appo11y:duration:stddev:threshold_by_covar
        - record: appo11y:error:ratio:stddev_1h
          expr: stddev_over_time(appo11y:error:ratio[1h])
    - name: baseline-request-rate
      interval: 1m
      rules:
        - record: appo11y:request:rate5m
          expr: sum by (k8s_cluster_name, k8s_namespace_name, service, span_name) (rate(traces_spanmetrics_latency_count{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m))
        - record: appo11y:request:rate5m
          expr: sum by (k8s_cluster_name, k8s_namespace_name, service) (rate(traces_spanmetrics_latency_count{source="tempo", span_kind=~"SPAN_KIND_SERVER|SPAN_KIND_CONSUMER"}[5m] offset 1m))
          labels:
            span_name: __aggregated__
        - record: appo11y:request:rate5m:select
          expr: appo11y:request:rate5m > 0 and (max_over_time(appo11y:request:rate5m[1h] offset 23h30m) > 0 or max_over_time(appo11y:request:rate5m[1h] offset 6d23h30m) > 0) unless avg_over_time(appo11y:request:rate5m[1h]) < on () group_left () appo11y:request:rate:sparse_threshold
        - record: appo11y:request:rate5m:prediction_st
          expr: avg_over_time(appo11y:request:rate5m:select[1h])
        - record: appo11y:request:rate5m:stddev_st
          expr: avg_over_time(appo11y:request:rate5m:stddev_st_1h[1d2h])
        - record: appo11y:request:rate5m:anomaly_lower_threshold
          expr: clamp_min(min without (prediction_type) (label_replace(last_over_time(appo11y:request:rate5m:prediction_st[2m]) - last_over_time(appo11y:request:rate5m:stddev_st[2m]) * on () group_left () appo11y:request:rate:threshold_by_stddev, "prediction_type", "short_term", "", "") or label_replace(last_over_time(appo11y:request:rate5m:prediction_st[2m]) - last_over_time(appo11y:request:rate5m:prediction_st[2m]) * on () group_left () appo11y:request:rate:threshold_margin, "prediction_type", "margin", "", "") or last_over_time((min without (look_back) (label_replace(avg_over_time(appo11y:request:rate5m:select[1h] offset 6d23h30m) - stddev_over_time(appo11y:request:rate5m:select[1h] offset 6d23h30m) * on () group_left () appo11y:request:rate:threshold_by_stddev, "look_back", "1w", "", "") or label_replace(avg_over_time(appo11y:request:rate5m:select[1h] offset 23h30m) - stddev_over_time(appo11y:request:rate5m:select[1h] offset 23h30m) * on () group_left () appo11y:request:rate:threshold_by_stddev, "look_back", "1d", "", "")))[10m:1m])), 0)
        - record: appo11y:request:rate5m:anomaly_upper_threshold
          expr: max without (prediction_type) (label_replace(last_over_time(appo11y:request:rate5m:prediction_st[2m]) + last_over_time(appo11y:request:rate5m:stddev_st[2m]) * on () group_left () appo11y:request:rate:threshold_by_stddev, "prediction_type", "short_term", "", "") or label_replace(last_over_time(appo11y:request:rate5m:prediction_st[2m]) + last_over_time(appo11y:request:rate5m:prediction_st[2m]) * on () group_left () appo11y:request:rate:threshold_margin, "prediction_type", "margin", "", "") or last_over_time((max without (look_back) (label_replace(avg_over_time(appo11y:request:rate5m:select[1h] offset 6d23h30m) + stddev_over_time(appo11y:request:rate5m:select[1h] offset 6d23h30m) * on () group_left () appo11y:request:rate:threshold_by_stddev, "look_back", "1w", "", "") or label_replace(avg_over_time(appo11y:request:rate5m:select[1h] offset 23h30m) + stddev_over_time(appo11y:request:rate5m:select[1h] offset 23h30m) * on () group_left () appo11y:request:rate:threshold_by_stddev, "look_back", "1d", "", "")))[10m:1m]))